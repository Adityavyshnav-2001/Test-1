{%- doc -%}
  Renders a "Buy Now" button that adds the product to cart and redirects to checkout.
  
  @param {boolean} can_add_to_cart - Whether the product can be added to the cart.
  @param {object} product - The product object to be added to the cart.
  @param {string} [class] - Additional CSS classes to apply to the button.
  @param {string} [id] - The ID attribute for the button.
{%- enddoc -%}

{%- liquid
  assign buy_now_text = 'actions.buy_now' | t
-%}

<buy-now-button class="buy-now-form" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
  <button
    {% if id != blank %}
      id="{{ id }}"
    {% endif %}
    type="button"
    class="button {{ class }} buy-now-btn"
    {% unless can_add_to_cart %}
      disabled
    {% endunless %}
  >
    <span class="buy-now-text">
      <span class="buy-now-text__content">
        <span>{{ buy_now_text }}</span>
      </span>
    </span>
  </button>
</buy-now-button>

<script>
  if (!customElements.get('buy-now-button')) {
    customElements.define('buy-now-button', class BuyNowButton extends HTMLElement {
      constructor() {
        super();
        this.button = this.querySelector('button');
        this.button.addEventListener('click', this.handleClick.bind(this));
      }

      async handleClick(event) {
        event.preventDefault();
        
        const variantId = this.dataset.variantId;
        
        if (!variantId) return;
        
        this.button.disabled = true;
        
        try {
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              items: [{
                id: parseInt(variantId),
                quantity: 1
              }]
            })
          });
          
          if (response.ok) {
            window.location.href = '/checkout';
          } else {
            this.button.disabled = false;
          }
        } catch (error) {
          console.error('Buy now error:', error);
          this.button.disabled = false;
        }
      }
    });
  }
</script>

{% stylesheet %}
  .buy-now-form {
    width: 100%;
  }

  .buy-now-button {
    width: 100%;
    height: var(--height-buy-buttons);
    user-select: none;
    transition-property: color, box-shadow, background-color, scale, translate;
    transition-duration: var(--animation-speed);
    transition-timing-function: var(--ease-out-cubic);
  }

  .buy-now-button:active {
    scale: 0.99;
    translate: 0 1px;
  }

  .buy-now-text {
    display: flex;
    gap: var(--gap-2xs);
    align-items: center;
    justify-content: center;
  }
{% endstylesheet %}
